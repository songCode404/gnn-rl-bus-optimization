import pandas as pd

# =========================================================
# ğŸ“‚ 1. íŒŒì¼ ê²½ë¡œ ì„¤ì • (íŒŒì¼ ì´ë¦„ì„ ë³¸ì¸ ê²ƒì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”!)
# =========================================================
# (A) ì•”í˜¸í‘œ: ì„œìš¸ì‹œ ë²„ìŠ¤ë…¸ì„ ID ì •ë³´ (ì—‘ì…€ íŒŒì¼)
mapping_file = "data/ë²„ìŠ¤ë…¸ì„ ë²ˆí˜¸.csv" 

# (B) ë©”ì¸ ë°ì´í„°: ì„œìš¸ì‹œ ë…¸ì„ ë³„ ì •ë¥˜ì†Œ êµ¬ê°„ë³„ ìš´í–‰ì‹œê°„ ì •ë³´ (CSV íŒŒì¼)
data_file = "data/êµ¬ê°„ë³„_í‰ê· ì†ë„.csv" 

# ê²°ê³¼ ì €ì¥í•  íŒŒì¼ ì´ë¦„
output_file = "14Xë²ˆ_ë²„ìŠ¤_ëª¨ìŒ_ë°ì´í„°.csv"

# =========================================================
# ğŸš€ 2. 14Xë²ˆ ë²„ìŠ¤ì˜ ID ì°¾ê¸° (Mapping)
# =========================================================
print("ğŸ” ë…¸ì„  ID ë§¤í•‘ ì •ë³´ë¥¼ ì½ëŠ” ì¤‘...")
df_map = pd.read_csv(mapping_file, encoding='cp949')

# â­ [DEBUGING] ì»¬ëŸ¼ ì´ë¦„ì„ í„°ë¯¸ë„ì— ì¶œë ¥í•´ì„œ í™•ì¸í•˜ê¸°
print("\nğŸ“‹ ì—‘ì…€ íŒŒì¼ì— ìˆëŠ” ì§„ì§œ ì»¬ëŸ¼ ì´ë¦„ë“¤:", df_map.columns.tolist())
print(df_map.head())
print("-" * 30)

route_name_col = 'ë…¸ì„ ëª…'
route_id_col = 'ë…¸ì„ '

# [í•µì‹¬ ë¡œì§] "14"ë¡œ ì‹œì‘í•˜ê³ , ê¸€ì ìˆ˜ê°€ ë”± 3ìë¦¬ì¸ ê²ƒë§Œ ì°¾ê¸° (ì˜ˆ: 140, 141...)
# (ì´ê±¸ ì•ˆ í•˜ë©´ 1411ë²ˆ ê°™ì€ ì´ˆë¡ ë²„ìŠ¤ë„ ì„ì¼ ìˆ˜ ìˆìŒ)
df_14x = df_map[
    df_map[route_name_col].astype(str).str.startswith('14') & 
    (df_map[route_name_col].astype(str).str.len() == 3)
]

# ì°¾ì€ ID ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
target_ids = df_14x[route_id_col].unique()
target_names = df_14x[route_name_col].unique()

print(f"âœ… ì°¾ì€ 14Xë²ˆ ë²„ìŠ¤ ëª©ë¡ ({len(target_names)}ê°œ): {target_names}")
print(f"ğŸ”‘ ì¶”ì¶œí•  ë…¸ì„  ID ëª©ë¡: {target_ids}")

# =========================================================
# ğŸ§¹ 3. ë©”ì¸ ë°ì´í„°ì—ì„œ í•„í„°ë§í•˜ê¸°
# =========================================================
print(f"\nğŸ“‚ ë©”ì¸ ë°ì´í„°({data_file})ë¥¼ ì½ëŠ” ì¤‘... (ìš©ëŸ‰ì´ ì»¤ì„œ ì¢€ ê±¸ë¦½ë‹ˆë‹¤)")

# CSV ì½ê¸° (ì¸ì½”ë”© ì—ëŸ¬ ë°©ì§€)
try:
    df_data = pd.read_csv(data_file, encoding='cp949')
except:
    df_data = pd.read_csv(data_file, encoding='utf-8')

# ë°ì´í„°ì˜ ë…¸ì„ ID ì»¬ëŸ¼ ì´ë¦„ ì°¾ê¸°
data_id_col = 'ë…¸ì„ _ID'

# [í•„í„°ë§] ìš°ë¦¬ê°€ ì°¾ì€ ID ë¦¬ìŠ¤íŠ¸(target_ids)ì— í¬í•¨ëœ ë°ì´í„°ë§Œ ë‚¨ê¸°ê¸°
df_filtered = df_data[df_data[data_id_col].isin(target_ids)]

# â­ [DEBUGING] ë©”ì¸ ë°ì´í„°ì˜ ì»¬ëŸ¼ ì´ë¦„ì„ ì¶œë ¥í•´ì„œ í™•ì¸í•˜ê¸°
print("\nğŸ“‹ ë©”ì¸ ë°ì´í„°(ìš´í–‰ì‹œê°„)ì˜ ì§„ì§œ ì»¬ëŸ¼ ì´ë¦„ë“¤:", df_data.columns.tolist())
print("-" * 30)

print(f"ğŸ“Š í•„í„°ë§ ê²°ê³¼: ì „ì²´ {len(df_data)}í–‰ ì¤‘ -> {len(df_filtered)}í–‰ ì¶”ì¶œë¨!")

# =========================================================
# ğŸ’¾ 4. ì €ì¥í•˜ê¸°
# =========================================================
# ë³´ê¸° ì¢‹ê²Œ ë…¸ì„ ëª…ë„ ë¶™ì—¬ì£¼ë©´ ì¢‹ìŒ (Merge)
df_final = pd.merge(df_filtered, df_14x[[route_id_col, route_name_col]], 
                    left_on=data_id_col, right_on=route_id_col, how='left')

df_final.to_csv(output_file, index=False, encoding='cp949')
print(f"ğŸ‰ ì €ì¥ ì™„ë£Œ! íŒŒì¼ëª…: {output_file}")
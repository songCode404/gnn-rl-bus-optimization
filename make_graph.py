import numpy as np
import pickle
import os

# ==========================================
# ğŸ”§ 1. ì„¤ì • (ì¤‘ìš”!)
# ==========================================
# ì•„ê¹Œ make_speed_dataset.py ì‹¤í–‰ ê²°ê³¼ì—ì„œ í™•ì¸í•œ 'êµ¬ê°„(ì •ë¥˜ì¥) ê°œìˆ˜'ë¥¼ ì ìœ¼ì„¸ìš”.
# í™•ì¸í•´ì£¼ì‹  ìˆ«ìê°€ 56ì´ì—ˆìœ¼ë¯€ë¡œ 56ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
num_nodes = 706  

# ì €ì¥í•  ìœ„ì¹˜ (Graph-WaveNetì´ ì°¾ëŠ” ê¸°ë³¸ ê²½ë¡œ)
output_dir = "data/sensor_graph"
output_file = "adj_mx.pkl"

# ==========================================
# ğŸ—ºï¸ 2. ê°€ì§œ ì§€ë„ ë°ì´í„° ìƒì„±
# ==========================================
print(f"nodes: {num_nodes}ê°œì— ëŒ€í•œ ë¹ˆ ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...")

# (1) ì„¼ì„œ ID ë¦¬ìŠ¤íŠ¸ (ê·¸ëƒ¥ '0', '1', '2'... '55' ë¡œ ë§Œë“­ë‹ˆë‹¤)
sensor_ids = list(range(num_nodes))
sensor_ids = [str(i) for i in sensor_ids]

# (2) IDë¥¼ ì¸ë±ìŠ¤ë¡œ ë°”ê¾¸ëŠ” ë”•ì…”ë„ˆë¦¬ {'0': 0, '1': 1 ...}
sensor_id_to_ind = {k: v for v, k in enumerate(sensor_ids)}

# (3) ì¸ì ‘ í–‰ë ¬ (Adjacency Matrix)
# ì¼ë‹¨ ì•„ë¬´ê²ƒë„ ì—°ê²° ì•ˆ ëœ 'ë‹¨ìœ„ í–‰ë ¬(Identity Matrix)'ë¡œ ë§Œë“­ë‹ˆë‹¤.
# ëŒ€ê°ì„ ë§Œ 1ì´ê³  ë‚˜ë¨¸ì§€ëŠ” 0ì¸ í–‰ë ¬ì…ë‹ˆë‹¤.
# (ì–´ì°¨í”¼ í•™ìŠµí•  ë•Œ --randomadj ì˜µì…˜ì„ ì¼œë©´, AIê°€ ì•Œì•„ì„œ ì§„ì§œ ê´€ê³„ë¥¼ ì°¾ì•„ëƒ…ë‹ˆë‹¤.)
adj_mx = np.eye(num_nodes)

# ==========================================
# ğŸ’¾ 3. ì €ì¥
# ==========================================
# í´ë”ê°€ ì—†ìœ¼ë©´ ë§Œë“­ë‹ˆë‹¤.
os.makedirs(output_dir, exist_ok=True)
full_path = os.path.join(output_dir, output_file)

# í”¼í´(pickle) íŒŒì¼ë¡œ ì €ì¥
with open(full_path, 'wb') as f:
    # Graph WaveNetì´ ì›í•˜ëŠ” ìˆœì„œëŒ€ë¡œ ë¬¶ì–´ì„œ ì €ì¥
    pickle.dump([sensor_ids, sensor_id_to_ind, adj_mx], f)

print(f"ğŸ‰ ì„±ê³µ! ê°€ì§œ ì§€ë„ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: {full_path}")
print("ì´ì œ train.pyë¥¼ ì‹¤í–‰í•´ë„ ì§€ë„ íŒŒì¼ ì—†ë‹¤ëŠ” ì—ëŸ¬ê°€ ì•ˆ ë‚  ê²ë‹ˆë‹¤!")